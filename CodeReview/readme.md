> 前端技术体系的改进和人员梯队的培养

关键字：

- 微前端
- SSR
- Node 性能
- 前端监控等

## 背景

1. 技术栈

| 端         | 特有                       | 通用                |
| ---------- | -------------------------- | ------------------- |
| PC         | React/TypeScript           | ES6/ESlint/prettier |
| H5         | Vue/SSR                    |                     |
| 多端小程序 | 微信小程序/百度小程序      |                     |
| Node       | Koa/YouZanFrameWork/NestJS |                     |

2. 团队架构

在构建项目的前期，前端对业务项目按端来划分人员，各端各司其职，各自沉淀。

中期随着产品的基本成型，前端团队人员按照业务领域划分成了多个子业务组前端，各组负责 4 端中对应模块的业务。

一个前端工程师至少要维护 4 个不同的编码上下文项目，好处是技术多样丰富，但是瓶颈也同样存在，一个前端工程需需要多端的开发能力，在编码规范和代码风格检查尽可能统一的情况下，因为上述技术体系的差异，我们还是不得不需要熟悉四端的技术架构、开发流程、数据流处理、资产市场、最佳实践。

业务小组之间成立了一个小型的前端技术委员会，来应对这种变化：

- 总结原先的项目技术规范，统一宣讲、培训、文档化
- 打造统一标准化的研发流程
- 并且持续汲取新的实践并迭代

组织架构调整

按端划分 -> 业务小组划分（每组成员需要有熟悉四端技术架构）-> 技术委员会 -> 制定统一的流程规范

3. 代码质量问题

- 项目 Bug 较多，同样的坑不同的人会踩
- 迭代后的代码难以维护，包括代码可读性、复用性低等
- 模块的整体设计也欠缺，扩展能力难以支撑业务发展

对代码质量的把控方面，现状流程是： 半年对几端的项目代码进行一次整体的 code review。

问题：code review 周期时间过长，会影响涉及人员对业务开发进度。

解决：小步快跑的模式，尽可能早的从开始就参与进来，更高频率，增强审计和设计把控，减少后面返工和带来 Bug 所影响的整体效率。

## 定义需求

确定了背景和改进诉求，重新定义一下我们做这件事的目的和价值。

1. 从源头把控代码质量和效率

- 统一代码的评判标准和认知
- 发现边界问题
- 提出改进建议

2. 共享和迭代集体代码智慧

- 交流设计思路和编码实践
- 沉淀最佳实践
- 迭代统一规范

实践过程中会遇到的问题：

- 评判标准是什么
- 各方收获了什么
- 找谁 review
- 如何发现深层次问题
- 什么时候 review
- 该关注点在哪
- 小的点会改，大的调整怎么办
- review 的建议真的改了吗

基于这些诉求和待解决问题，我们需要对整体的标准和每一次 Code Review 的关键控制点进行细化和量化，于是有了我们第一版 Code Review 的 SOP （标准作业流程）。

## V1.0.0 标准化

1. 建立规范

1.1 宣讲

宣讲各端统一代码规范和最佳实践、编码原则。Code Review 的基础是有基本的代码规范和原则，同时要同步给大家。

1.2 Review 小组

成立专门的 code review 小组，小组成员是各端经验丰富的人员，这样才能比较好的保障初期 Review 有比较好的效果，可以让 Code 人员有更大收获，先富带后富，经历多次 Code Review 对其标准之后，更多 Code 优秀的同学也可以加入进来，讨论对规范和原则的实践。

1.3 设定可迭代的代码质量评价维度和标准：

每项 1~5 分，基准分为 3 分，得分在此基础上根据评分点浮动，总评分为各项得分的平均分。

基本面： 对团队既定规范的遵循和代码开发的改动量我们做评分的第一个基础。

- 难度大、工作量大，可酌情加分
- 是否符合基本规范

架构设计：是否有整体设计，设计是否合理，设计是否遵循了设计，这是第二个维度

- 如果有设计文档，是否按照设计文档思路来写代码，是可酌情加分
- review 的人是否发现了更好的解决方案
- 代码是否提供了很好的解决思路

代码：代码细节上是否尽可能保持简单和易读，同时鼓励细节优化是我们的第三个维度

- 是否明显重复代码
- 是否合理抽取枚举值，禁止使用“魔法值”
- 是否合理使用已有的组件和方法
- 对已有的、不合理的代码进行重构和优化
- 职责（组件、方法）、概念是否清晰

健壮性：错误处理、业务逻辑的边界和基本的安全性使我们的第四个维度

- 边界和异常是否考虑完备
- 在 review 阶段是否发现明显 bug
- 是否考虑安全性(xss)

效率： 是否贡献了整体，为物料库和工具库添砖加瓦，与整体沉淀形成闭环，是我们第五个维度的初衷

- 是否抽取共用常量到 beauty-const 库，加分
- 是否抽取机沉淀基础组件和通用业务组件到组件库，加分

  1.4 申请格式

Code 人在企业微信群发起 Review 请求，统一参考格式，内容包括：

mr 地址、产品文档、UI 稿、技术设计、效率平台、接口文档

原则是为 Review 方尽可能提供足够的信息来判断 Code 的好坏，去更好发现深层次问题。

当然文档也说不到全部的上下文，所以我们需要分配 Review 人员时候考虑栈和业务相关熟悉度，必要时候 Code 人员要向 Review 人员口述需求、代码思路和重点。

1.5 reveiw 要求

- code review 必须在提测前进行，确保线上前能够完成 Review。
- review 人根据 code review 评分标准 打出各项评分，计算出本次 code review 总评分
- 有需要可在备注中说明原因，代码相关的备注可以直接在 gitlab 进行
- code 解决反馈的问题
- 要求提测邮件中体现 code review 情况（评分、遗留问题）
- mr 统一由 feature 分支合并到 release 分支
- review 记录，定期同步分享

  1.6 review 重点

- 建议 check 代码改动范围，重点关注核心代码改动的影响
- review 可以针对重点代码进行
- 每项 checklist，如果有不符合 checklist 内容的，请在后面【评分解释】中具体指出
- 【讨论沉淀】内容可包括但不限于：技术设计情况、review 过程中发现的亮点与不足、值得探讨的东西、发现 bug
- 周会定期同步 review 情况，分享优秀代码

2. 单次流程

| 阶段             | 环节                       | 内容                                        | 负责人  |
| ---------------- | -------------------------- | ------------------------------------------- | ------- |
| 提交 Code Review | 准备 Code Review 文档      | 1.需求文档 2.UI 设计稿 3.技术方案 4.MR 地址 | code 方 |
| H5               | Vue/SSR                    |                                             |         |
| 多端小程序       | 微信小程序/百度小程序      |                                             |         |
| Node             | Koa/YouZanFrameWork/NestJS |                                             |         |

- 通过统一提交文档和口述，Code 方养成了技术设计和理清重点和评估影响范围的习惯。
- 通过讨论和反馈 Code Review 双方都从讨论中获取到了编码智慧的碰撞和交流，整体的代码水平总和得到了提升。
- 通过 Review，代码的总体设计和细节得到了更好的保障。
- 通过沉淀最佳实践和改进建议，团队规范和 Code Review 形成了内循环。

## V2.0.0 平台化

1.0 的版本在持续的细节迭代，做到了比较满意的标准化作业，但是有几个比较大的缺陷：

1. 操作欠缺自动化

- 流程的很多环节明显可以自动化，节省重复的工作量
- 对流程的把控依赖人，容易执行不到位

2. 信息欠缺数字化

- 对 code review 的评分统计需要人工，工作量大
- code review 的总览和数据分析可以支持更好的判断团队问题和决策提升整体代码质量的策略

3. 流程欠缺可视化

- 所有流程应该是可以大盘总览的，单个详情全面的
- 每个 code review 事务的状态是可见的

把 Code Review 整套流程做成已有的内部前端工具平台中的一个模块的想法，以期达到可视化、自动化、数字化的目的。

投入产出比是我们需要考虑的，虽然这件事情没有直接的业务价值，但是有非常好的质量把控和能力量化的价值，并且有标杆式的团队建设价值，人员成长了，更好地为业务服务。
